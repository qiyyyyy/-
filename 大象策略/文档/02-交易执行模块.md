# 交易执行模块

## 模块作用

交易执行模块是大象策略的关键组件，负责执行交易指令、管理订单状态、处理成交回报，以及协调交易时机。它充当了策略决策和实际交易操作之间的桥梁，确保交易以最优方式执行。

## 基本功能

交易执行模块主要提供以下功能：

1. **订单发送**：根据策略决策发送买入/卖出订单
2. **订单管理**：跟踪和管理活跃订单状态
3. **成交处理**：处理订单成交回报，更新交易记录
4. **超时撤单**：自动撤销长时间未成交的订单
5. **重试机制**：根据需要重新发送订单
6. **交易统计**：记录交易次数、成功率、盈亏等信息

## 参数配置

交易执行器具有以下可配置参数：

| 参数名 | 默认值 | 说明 |
|-------|------|------|
| 价格偏移量 | 0.01 | 最小价格变动单位(元) |
| 卖出偏移量倍数 | 2.0 | 卖出价高于大象价格的偏移量倍数 |
| 买入偏移量倍数 | 1.0 | 买入价高于大象价格的偏移量倍数 |
| 等待时间 | 30 | 等待订单成交的最长时间(秒) |
| 冷却时间 | 300 | 同一股票交易后的冷却时间(秒) |
| 止损价格比例 | 0.5 | 相对于大象价差的止损比例 |
| 调戏模式 | True | 是否启用调戏大象模式 |
| 交易量 | 100 | 调戏模式下每次交易的数量(股) |
| 最小止盈点数 | 2 | 调戏模式下止盈的点数 |
| 最小止损点数 | 2 | 调戏模式下止损的点数 |

### 如何修改参数

#### 方法一：通过配置文件修改

在`config/global_params.json`中添加或修改：

```json
{
  "交易执行": {
    "价格偏移量": 0.01,
    "卖出偏移量倍数": 2.0,
    "买入偏移量倍数": 1.0,
    "等待时间": 30,
    "冷却时间": 300,
    "止损价格比例": 0.5,
    "调戏模式": true,
    "交易量": 100,
    "最小止盈点数": 2,
    "最小止损点数": 2
  }
}
```

#### 方法二：通过网页界面修改

1. 启动网页管理界面
2. 登录后在"设置"选项卡中找到"交易执行"部分
3. 修改参数并保存

## 使用指南

### 调戏模式说明

"调戏大象"是策略的核心交易模式，其基本思路是：

1. 在大象价格附近小额频繁交易
2. 利用短期价格波动获利
3. 快速止盈止损，控制风险

参数设置建议：
- **交易量**：建议使用较小的交易量（100-300股），以降低风险
- **最小止盈点数**：2-3个点通常是合理的设置
- **最小止损点数**：和止盈点数相同或略小

### 价格偏移设置指南

价格偏移量决定了交易价格与大象价格的关系：

- **买入偏移量倍数**：设置过高会降低成交概率，但可能有更好的买入价格
- **卖出偏移量倍数**：设置过高会降低成交概率，但可能有更好的卖出价格

建议根据股票的活跃度调整：
- 活跃股票可以使用较大的偏移量（如2.0-3.0）
- 不活跃股票应使用较小的偏移量（如1.0-1.5）

### 订单等待和冷却时间

- **等待时间**：订单未成交自动撤单的时间，建议10-30秒
- **冷却时间**：同一只股票两次交易之间的最短间隔，建议300-600秒

这两个参数影响交易频率和效率：
- 等待时间过长会占用资金但增加成交机会
- 冷却时间过短会增加交易频率但可能导致过度交易

## 高级功能

### 自定义交易策略

交易执行模块支持自定义交易策略。以下是一个简单示例：

```python
from 大象策略.modules.交易执行 import 交易执行器

class 自定义交易执行器(交易执行器):
    def 计算买入价格(self, 大象信息):
        # 自定义买入价格计算逻辑
        买入价 = 大象信息["价格"] + (self.价格偏移量 * 0.5)  # 自定义偏移量
        return 买入价
        
    def 计算卖出价格(self, 大象信息):
        # 自定义卖出价格计算逻辑
        卖出价 = 大象信息["价格"] + (self.价格偏移量 * 3.0)  # 自定义偏移量
        return 卖出价
```

### 订单管理与监控

交易执行器提供了订单管理和监控功能：

```python
# 获取当前活跃订单
活跃订单 = 交易执行器.活跃订单

# 获取历史交易记录
交易历史 = 交易执行器.订单历史

# 获取交易统计
统计信息 = 交易执行器.交易统计
```

### 与风控模块的结合

交易执行模块会在订单发送前咨询风控模块，确保交易符合风险控制规则：

```python
# 发送买入订单前检查风控
if self.风控.检查风控(股票代码, 预估盈亏):
    # 通过风控检查，执行交易
    self.发送买入订单(...)
else:
    # 未通过风控检查，放弃交易
    self.logger.warning(f"股票 {股票代码} 未通过风控检查，取消交易")
```

## 常见问题

### 问题1：订单总是未成交怎么办？

可能原因及解决方案：
- **价格偏移量过大**：减小偏移量倍数
- **市场流动性不足**：增加等待时间
- **股票波动太小**：调整交易时间段或选择其他股票

### 问题2：交易频率过高怎么处理？

可能原因及解决方案：
- **冷却时间过短**：延长冷却时间
- **风控参数过宽松**：调整风控参数
- **大象识别阈值过低**：提高大象识别阈值

### 问题3：如何处理踏空和追高的问题？

- **踏空**：可能是大象识别阈值过高，考虑适当降低
- **追高**：可能是止盈设置过低，考虑增加最小止盈点数

## 与其他模块的协作

交易执行模块与以下模块密切协作：

1. **大象识别模块**：接收大象信息，决定交易时机和价格
2. **风险控制模块**：交易前进行风险检查
3. **资金管理模块**：检查资金是否充足，管理持仓

## 性能优化建议

1. **降低查询频率**：过于频繁地查询订单状态可能影响性能
2. **批量处理**：尽可能批量处理订单和成交回报
3. **错误重试**：添加适当的错误处理和重试机制
4. **日志级别**：生产环境中调整日志级别为INFO或WARNING

## 总结

交易执行模块是策略与市场之间的接口，正确配置和使用交易执行模块对策略的实际表现至关重要。建议新用户：

1. 从保守的交易参数开始
2. 重点关注订单的成交率
3. 根据交易结果逐步优化参数
4. 定期检查交易统计信息 