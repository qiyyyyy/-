# 大象策略用户手册

本文档详细介绍大象策略的日常使用方法，包括参数设置、账户配置、网页管理和运行维护等内容。

## 参数设置方法

大象策略提供多种参数设置方式，您可以根据需要选择最合适的方式：

### 1. 修改主策略文件

主策略文件位于 `大象策略/大象策略.py`，其中定义了所有交易参数的默认值：

```python
# 以下是主策略文件中的参数定义示例（实际参数可能有所不同）
class 大象策略(CtaTemplate):
    # 策略参数
    # 大象识别参数
    大象委托量阈值 = 1000000  # 单位：元
    大象价差阈值 = 0.3  # 百分比
    大象确认次数 = 3
    大象稳定时间 = 5  # 秒
    
    # 交易执行参数
    价格偏移量 = 0.01
    卖出偏移量倍数 = 2
    买入偏移量倍数 = 1
    等待时间 = 30  # 秒
    冷却时间 = 60  # 秒
    
    # 其他参数...
```

直接编辑此文件可以永久修改默认参数值。修改后需要重新启动策略使其生效。

### 2. 通过VNPY图形界面设置

如果使用VNPY图形界面加载策略：

1. 在VNPY主界面中，选择"CTA策略"应用
2. 点击"添加策略"按钮
3. 选择"大象策略"后，会显示参数设置界面
4. 修改所需参数，点击"确定"保存

这种方式适合在策略首次加载时设置参数。

### 3. 通过网页管理界面设置

如果启用了网页管理功能：

1. 在浏览器中访问 `http://localhost:8088`（或设置的其他端口）
2. 登录后进入"参数设置"页面
3. 修改参数值并保存

网页界面的优点是可以在策略运行过程中实时调整参数，无需重启策略。这对于参数优化和紧急调整非常有用。

### 4. 配置文件设置（高级用户）

对于需要自动化部署的高级用户，可以创建JSON格式的参数配置文件：

```bash
# 创建参数配置文件
nano ~/vnpy/strategies/大象策略_config.json
```

```json
{
  "大象委托量阈值": 1200000,
  "大象价差阈值": 0.25,
  "大象确认次数": 4,
  "股票池比例": 0.5,
  "单股最大仓位比例": 0.1
  // 其他参数...
}
```

然后在启动脚本中加载此配置：

```python
# 在run_strategy.py中修改
cta_engine.add_strategy("大象策略", "大象策略", load_json("~/vnpy/strategies/大象策略_config.json"))
```

这种方式适合需要批量部署或经常切换不同参数组合的场景。

## 交易账户配置

运行策略前，需要配置交易所账户以接入实际市场。VNPY框架支持多种交易接口，以下是配置方法：

### 通过图形界面配置（Windows用户推荐）

1. **启动VNPY主界面**
   ```
   cd vnpy安装目录
   python run.py
   ```

2. **添加交易接口**
   - 点击主界面上的"系统"菜单
   - 选择"连接"选项
   - 从弹出窗口中选择对应的证券接口（如CTP、XTP等）
   - 点击"添加"按钮

3. **填写账户信息**
   - 用户名/账号
   - 密码
   - 经纪商ID（如适用）
   - 交易服务器地址
   - 行情服务器地址
   - 产品信息
   - 授权编码（如需要）

4. **连接验证**
   - 填写完成后点击"连接"按钮
   - 连接成功后状态会显示为"已连接"
   - 在"交易"选项卡可查看账户资产和持仓信息

### 通过配置文件设置（Linux服务器推荐）

1. **创建配置目录和配置文件**
   ```bash
   mkdir -p ~/vnpy/config
   nano ~/vnpy/config/vt_setting.json
   ```

2. **添加账户配置信息**
   ```json
   {
     "font.family": "微软雅黑",
     "font.size": 12,
     "CTP": [
       {
         "用户名": "您的交易账号",
         "密码": "您的密码",
         "经纪商代码": "您的经纪商ID",
         "交易服务器": "交易服务器地址",
         "行情服务器": "行情服务器地址",
         "产品名称": "simnow_client_test",
         "授权编码": "0000000000000000"
       }
     ]
   }
   ```

3. **在启动脚本中添加自动连接代码**
   ```python
   # 在run_strategy.py的main函数中添加
   # 添加交易接口
   main_engine.add_gateway(CtpGateway)
   
   # 自动连接账户
   main_engine.connect(
       "CTP",  # 根据实际使用的接口更改
       setting={
           "用户名": "您的交易账号",
           "密码": "您的密码",
           "经纪商代码": "您的经纪商ID",
           "交易服务器": "交易服务器地址",
           "行情服务器": "行情服务器地址",
           "产品名称": "simnow_client_test",
           "授权编码": "0000000000000000"
       }
   )
   ```

### 常见交易接口参数说明

1. **CTP接口**（中国期货市场）
   - 用户名：期货账户号
   - 密码：交易密码
   - 经纪商代码：期货公司提供的经纪商ID
   - 交易/行情服务器：期货公司提供的服务器地址

2. **XTP接口**（国内证券市场）
   - 客户号：券商提供的资金账号
   - 密码：交易密码
   - 行情/交易地址：券商提供的服务器地址和端口
   - 证书文件路径：认证证书的本地路径

3. **其他证券接口**
   - 根据接口类型和券商要求提供相应信息
   - 详情可参考VNPY官方文档

### 测试账户连接

1. **查看连接日志**
   ```bash
   # Linux环境
   tail -f ~/strategy_log.txt
   
   # Windows环境
   # 查看VNPY主界面日志区域
   ```

2. **验证账户信息**
   - 检查账户余额和持仓信息是否正确显示
   - 确认可以接收行情数据
   - 可进行小额测试交易验证（谨慎操作）

> **注意**：首次使用实盘账户交易时，建议先使用仿真环境测试策略，确认无误后再切换至实盘。使用交易账户必须遵守相关交易所规则和法律法规。

## 核心参数说明

### 大象识别参数

- **大象委托量阈值**：判定为大象的最小委托金额（元）
- **大象价差阈值**：大象与卖一价的最大价差百分比
- **大象确认次数**：连续确认大象存在的次数要求
- **大象稳定时间**：大象稳定存在的最小秒数

### 交易执行参数

- **价格偏移量**：最小价格变动单位
- **卖出偏移量倍数**：卖出价高于大象价格的偏移量倍数
- **买入偏移量倍数**：买入价高于大象价格的偏移量倍数
- **等待时间**：等待订单成交的最长时间(秒)
- **冷却时间**：同一股票交易后的冷却时间(秒)

### 资金管理参数

- **股票池比例**：股票资金池目标比例
- **买回保障金比例**：现金池中作为买回保障的比例
- **单股最大仓位比例**：单只股票最大持仓占总资产比例

### 风险控制参数

- **单笔最大亏损比例**：单笔交易最大亏损占总资产比例
- **单股最大亏损比例**：单只股票日内最大亏损占总资产比例
- **日内最大亏损比例**：日内最大总亏损占总资产比例
- **单股最大交易次数**：单只股票日内最大交易次数
- **总交易次数限制**：日内总交易次数限制

### 网页管理参数

- **启用网页管理**：是否启用网页管理功能
- **网页管理端口**：网页管理服务器端口号
- **自动打开浏览器**：启动时是否自动打开管理界面

## 网页管理功能

策略提供了网页远程管理功能，可通过浏览器访问进行监控和控制：

### 页面功能说明

1. **首页**：显示策略概览和最近交易
   - 当前运行状态
   - 资金分配情况
   - 最近成交记录
   - 当日收益统计

2. **策略统计**：展示资金统计和风控状态
   - 股票池和现金池比例
   - 各股票持仓情况
   - 风控指标实时状态
   - 交易次数统计

3. **交易记录**：查看历史交易记录
   - 支持按日期、股票筛选
   - 显示盈亏情况
   - 可导出为CSV格式

4. **参数设置**：远程调整策略参数
   - 按模块分类显示参数
   - 实时保存和应用
   - 参数修改历史记录

5. **运行日志**：实时查看运行日志
   - 不同级别日志过滤
   - 支持关键词搜索
   - 日志自动刷新

### 访问方式

默认访问地址: `http://localhost:8088`

如果在远程服务器部署，可通过SSH隧道安全访问：
```bash
ssh -L 8088:localhost:8088 username@your_server_ip
```

然后在本地浏览器访问：`http://localhost:8088`

### 安全设置

网页管理功能默认只监听本地地址，如需从外部网络访问，请配置好防火墙和访问密码：

```python
# 在大象策略.py中设置
class 大象策略(CtaTemplate):
    # 网页管理参数
    网页管理密码 = "your_secure_password"  # 自定义访问密码
    允许远程访问 = False  # 是否允许从非本机IP访问，谨慎启用
```

## 日常运维操作

### 策略启动和停止

#### Windows环境

1. **启动策略**：
   - 在VNPY主界面中，选择CTA策略应用
   - 点击"添加策略"，选择大象策略
   - 点击"初始化"，然后点击"启动"

2. **停止策略**：
   - 在策略列表中选择大象策略
   - 点击"停止"按钮

#### Linux服务器

1. **启动策略**：
   ```bash
   # 使用systemd服务
   sudo systemctl start vnpy-strategy
   
   # 或手动启动
   nohup python ~/run_strategy.py > strategy_log.txt 2>&1 &
   ```

2. **停止策略**：
   ```bash
   # 使用systemd服务
   sudo systemctl stop vnpy-strategy
   
   # 或手动停止（找到进程ID后终止）
   ps aux | grep run_strategy.py
   kill [进程ID]
   ```

### 日志查看

1. **查看策略日志**：
   ```bash
   # Linux环境
   tail -f ~/strategy_log.txt
   
   # 查看最近100行日志
   tail -n 100 ~/strategy_log.txt
   ```

2. **查看系统服务日志**：
   ```bash
   sudo journalctl -u vnpy-strategy -f
   ```

### 数据备份

定期备份策略数据，特别是交易记录和持仓信息：

```bash
# 创建备份脚本
nano ~/backup_strategy.sh
```

```bash
#!/bin/bash
BACKUP_DIR=~/strategy_backups
DATE=$(date +%Y%m%d)
mkdir -p $BACKUP_DIR/$DATE
cp -r ~/vnpy/strategies/大象策略/data $BACKUP_DIR/$DATE/
cp -r ~/vnpy/strategies/大象策略/logs $BACKUP_DIR/$DATE/
cp ~/strategy_log.txt $BACKUP_DIR/$DATE/
```

```bash
# 赋予执行权限
chmod +x ~/backup_strategy.sh

# 添加到定时任务，每天执行一次
crontab -e
# 添加以下行
0 21 * * * ~/backup_strategy.sh
```

### 系统监控

对于长期运行的策略，建议设置系统监控：

1. **CPU和内存监控**：
   ```bash
   # 安装监控工具
   sudo apt install htop
   
   # 查看系统资源使用情况
   htop
   ```

2. **网络连接监控**：
   ```bash
   # 查看网络连接状态
   netstat -an | grep 8088
   ```

3. **磁盘空间监控**：
   ```bash
   # 查看磁盘使用情况
   df -h
   ```

## 使用注意事项

### 交易准备

1. **初始持仓**：策略需要预先持有一定数量的股票才能开始高频交易，确保账户中已有足够的股票持仓

2. **资金配置**：根据策略设置，预先将资金合理分配为股票池和现金池，通常推荐50%/50%的初始配置

3. **股票选择**：
   - 优先选择流动性好、波动适中的股票
   - 避免选择近期有重大消息的股票
   - 建议选择中大市值、活跃度适中的股票

### 运行注意事项

1. **参数调整**：根据个人风险偏好和市场情况调整参数，初次使用建议采用保守设置

2. **风险控制**：
   - 合理设置止损条件，避免过度交易
   - 定期检查风控指标状态
   - 市场异常波动时考虑暂停策略

3. **网络要求**：使用网页管理功能时确保网络稳定，服务器部署需考虑网络延迟因素

4. **服务器选择**：如果使用云服务器，选择低延迟、高稳定性的配置，确保交易时段内系统稳定运行

5. **数据备份**：定期备份交易数据和配置文件，防止意外丢失

6. **账户安全**：
   - 定期更改交易账户和管理界面密码
   - 使用SSH隧道等安全方式访问远程管理界面
   - 避免在公共网络环境下操作

### 特殊情况处理

1. **策略异常停止**：
   - 检查日志确定停止原因
   - 修复问题后重新启动策略
   - 验证持仓和订单状态是否正确

2. **市场异常波动**：
   - 可通过网页管理界面临时调整参数或暂停策略
   - 极端情况下考虑手动干预交易

3. **服务器宕机**：
   - 确保有应急方案，如备用服务器
   - 恢复服务器后检查持仓和订单状态

4. **账户资金不足**：
   - 策略会自动控制交易规模，但仍需定期检查资金状况
   - 资金不足时考虑调整参数或追加资金

## 技术支持与问题解决

如遇到问题，可通过以下方式获取帮助：

1. 查阅日志文件，大部分问题都会在日志中有所反映
2. 检查VNPY官方文档和社区论坛
3. 联系策略开发者获取专业支持

常见问题解决方法可参考[技术文档](技术文档.md)中的相关章节。 