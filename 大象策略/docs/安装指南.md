# 大象策略安装指南

本文档详细介绍如何在不同环境下安装和部署大象策略。

## 前提条件

在开始安装前，请确保满足以下条件：

- VNPY 2.2.0+
- Python 3.7+ (推荐使用Python 3.9，与VNPY兼容性最佳)
- 已有证券账户接入

## Windows环境安装

### 1. 安装Python环境

1. 访问 [Python官网](https://www.python.org/downloads/)
2. 下载并安装Python 3.9
3. 安装时确保勾选以下选项：
   - "Add Python to PATH"
   - "Install pip"
   - "Install for all users"(推荐)

### 2. 安装TA-Lib（技术分析库）

TA-Lib是VNPY的重要依赖库，用于技术指标计算：

1. 访问 [TA-Lib预编译文件](https://www.lfd.uci.edu/~gohlke/pythonlibs/#ta-lib)
2. 根据Python版本下载对应wheel文件：
   - 对于Python 3.9 64位：`TA_Lib‑0.4.28‑cp39‑cp39‑win_amd64.whl`
   - 对于Python 3.9 32位：`TA_Lib‑0.4.28‑cp39‑cp39‑win32.whl`
3. 打开命令提示符，安装下载的文件：
   ```
   pip install TA_Lib‑0.4.28‑cp39‑cp39‑win_amd64.whl
   ```

### 3. 安装VNPY框架

#### 方法一：使用安装脚本

1. 从[GitHub](https://github.com/vnpy/vnpy)下载VNPY源码
2. 解压后运行根目录中的`install.bat`脚本
3. 安装完成后，可通过运行根目录中的`run.py`测试VNPY是否安装成功

#### 方法二：使用pip安装

```
pip install vnpy
```

### 4. 部署大象策略

1. 将`大象策略`文件夹复制到VNPY的策略目录中（通常在`vnpy/strategies/`）
2. 确保策略文件结构完整：
   ```
   大象策略/
   ├── modules/
   ├── config/
   ├── 大象策略.py
   └── README.md
   ```
3. 在`config/stocks.json`中配置交易股票列表

## Linux服务器安装

### 推荐服务器配置

#### 国内云服务商（推荐）

1. **阿里云 ECS**
   - 配置：2核4G内存，50GB SSD云盘
   - 系统：Ubuntu 20.04 LTS

2. **腾讯云 CVM**
   - 配置：2核4G内存，50GB SSD云硬盘
   - 系统：Ubuntu 20.04 LTS

#### 国际云服务商

- **DigitalOcean Droplet**：Basic Droplet，2核4GB内存

### 详细安装步骤

#### 1. 安装Python环境

```bash
# 更新系统包
sudo apt update
sudo apt upgrade -y

# 安装Python和开发工具
sudo apt install -y python3.9 python3.9-dev python3.9-venv python3-pip build-essential git

# 创建虚拟环境
mkdir ~/vnpy_env
cd ~/vnpy_env
python3.9 -m venv venv
source venv/bin/activate
```

#### 2. 安装TA-Lib依赖

```bash
# 安装依赖库
sudo apt install -y wget

# 下载并安装TA-Lib
wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
tar -xzf ta-lib-0.4.0-src.tar.gz
cd ta-lib/
./configure --prefix=/usr
make
sudo make install

# 安装Python绑定
pip install ta-lib
```

#### 3. 安装VNPY框架

```bash
# 克隆VNPY仓库
git clone https://github.com/vnpy/vnpy.git
cd vnpy

# 安装
bash install.sh
```

#### 4. 部署大象策略

```bash
# 创建策略目录
mkdir -p ~/vnpy/strategies/
cd ~/vnpy/strategies/

# 上传策略文件夹或克隆代码
# 使用SFTP/SCP上传或:
# git clone https://github.com/your-repo/大象策略.git

# 设置策略配置
nano 大象策略/config/stocks.json
# 添加您要交易的股票代码
```

#### 5. 创建启动脚本

> 注意：`run_strategy.py`文件需要自己创建，不是现成提供的文件。它用于在Linux服务器上自动启动VNPY和大象策略。

```bash
# 在用户主目录创建启动脚本
cd ~
nano run_strategy.py
```

粘贴以下代码到文件中：

```python
from vnpy.event import EventEngine
from vnpy.trader.engine import MainEngine
from vnpy.trader.ui import MainWindow, create_qapp
from vnpy.gateway.ctp import CtpGateway
from vnpy.app.cta_strategy import CtaStrategyApp

def main():
    """启动VNPY交易平台"""
    qapp = create_qapp()
    event_engine = EventEngine()
    main_engine = MainEngine(event_engine)
    
    # 添加交易接口
    main_engine.add_gateway(CtpGateway)
    
    # 添加应用
    main_engine.add_app(CtaStrategyApp)
    
    # 加载和初始化策略
    cta_engine = main_engine.get_engine("cta_strategy")
    cta_engine.init_engine()
    cta_engine.add_strategy("大象策略", "大象策略", {})
    cta_engine.init_all_strategies()
    cta_engine.start_all_strategies()
    
    print("策略已启动，运行中...")
    
    # 保持运行
    qapp.exec_()

if __name__ == "__main__":
    main()
```

```bash
# 保存并退出编辑器（在nano中按Ctrl+X，然后按Y确认保存）
# 赋予脚本执行权限
chmod +x ~/run_strategy.py
```

#### 6. 服务器后台运行

```bash
# 使用nohup后台运行
nohup python ~/run_strategy.py > strategy_log.txt 2>&1 &
```

#### 7. 设置自动重启服务

```bash
sudo nano /etc/systemd/system/vnpy-strategy.service
```

添加以下内容：

```
[Unit]
Description=VNPY Trading Strategy
After=network.target

[Service]
User=your_username
WorkingDirectory=/home/your_username/vnpy
ExecStart=/home/your_username/vnpy_env/venv/bin/python /home/your_username/run_strategy.py
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

```bash
# 保存退出后，启用服务
sudo systemctl enable vnpy-strategy
sudo systemctl start vnpy-strategy
```

#### 8. 开放网页管理端口

```bash
sudo ufw allow 8088/tcp
```

#### 9. 远程访问网页管理界面

通过SSH隧道安全访问：
```bash
# 在本地电脑执行
ssh -L 8088:localhost:8088 username@your_server_ip
```
然后在本地浏览器访问：`http://localhost:8088`

## 常见安装问题解决

### TA-Lib安装失败

#### Windows环境

1. **问题描述**：安装wheel文件时报错"不是针对该平台的有效wheel"
   **解决方案**：确认下载的wheel文件版本与Python版本匹配

2. **问题描述**：找不到vcvarsall.bat或编译错误
   **解决方案**：直接使用预编译的wheel文件，避免从源码编译

#### Linux环境

1. **问题描述**：make时出现编译错误
   **解决方案**：
   ```bash
   sudo apt-get install build-essential
   sudo apt-get install libta-lib-dev
   ```

2. **问题描述**：找不到ta-lib库
   **解决方案**：确保使用正确的安装路径
   ```bash
   ./configure --prefix=/usr
   ```

### VNPY安装问题

1. **问题描述**：安装依赖包时出现超时或连接错误
   **解决方案**：使用国内镜像源
   ```bash
   pip install -i https://pypi.tuna.tsinghua.edu.cn/simple vnpy
   ```

2. **问题描述**：缺少某些依赖包
   **解决方案**：手动安装缺失的包
   ```bash
   pip install numpy pandas matplotlib scipy qtpy pyqtgraph dataclasses
   ```

### 策略运行问题

1. **问题描述**：策略运行时提示缺少模块
   **解决方案**：检查Python路径和VNPY安装是否正确，可能需要设置PYTHONPATH
   ```bash
   export PYTHONPATH=$PYTHONPATH:~/vnpy
   ```

2. **问题描述**：无法加载策略
   **解决方案**：检查策略文件夹位置和名称，确保路径正确

## 验证安装

完成安装后，可通过以下方式验证大象策略是否正确安装：

### Windows环境

1. 运行VNPY主程序：
   ```
   python run.py
   ```

2. 在CTA策略应用中加载大象策略
3. 查看日志输出，确认无错误信息

### Linux环境

1. 检查服务状态：
   ```bash
   sudo systemctl status vnpy-strategy
   ```

2. 查看日志输出：
   ```bash
   tail -f strategy_log.txt
   ```

3. 通过网页管理界面检查策略状态 