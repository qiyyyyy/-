# 大象策略交易撤单机制

本文档详细介绍大象策略的交易撤单机制，包括撤单触发条件、实现方式和相关参数设置，帮助投资者理解策略如何处理未成交订单以优化交易结果。

## 撤单机制概述

大象策略采用自适应智能撤单机制，根据市场状况和订单情况动态决定是否撤销未成交订单。该机制旨在解决以下问题：

1. 减少因滑点造成的不利成交
2. 避免订单长时间挂在市场未成交
3. 在市场条件快速变化时及时调整策略
4. 优化资金使用效率，避免资金长时间锁定

## 撤单触发条件

策略支持多种撤单触发条件，可以同时启用：

### 1. 时间触发撤单

- **最长挂单时间**：订单发出后，如果在指定时间内（默认30秒）未完全成交，系统将自动撤销剩余未成交部分
- **盘中定时撤单**：在每个交易时段结束前固定时间（默认5分钟）自动撤销所有未成交订单，释放资金

### 2. 价格触发撤单

- **价格偏离撤单**：当市场价格相对于订单价格偏离超过设定阈值（默认0.3%）时触发撤单
- **大象信号消失撤单**：当原本触发买入的大象信号消失或减弱到阈值以下时，撤销相关联的未成交订单

### 3. 风控触发撤单

- **风控状态撤单**：当策略进入风控状态（如达到日内亏损限制）时，撤销所有未成交订单
- **流动性不足撤单**：当检测到股票流动性突然下降（如成交量萎缩）时，触发撤单操作

## 撤单实现方式

```python
def cancel_order_process(self, order_id: str, reason: str = ""):
    """
    撤销指定订单
    
    参数:
        order_id (str): 需要撤销的订单ID
        reason (str): 撤单原因，用于日志记录
    
    返回:
        bool: 撤单请求是否成功发送
    """
    # 检查订单是否存在且未完全成交
    if order_id not in self.active_orders:
        self.write_log(f"撤单失败：订单 {order_id} 不存在或已成交")
        return False
        
    # 发送撤单请求
    self.cancel_order(order_id)
    
    # 记录撤单事件
    self.write_log(f"发送撤单请求：订单 {order_id}，原因：{reason}")
    
    # 更新订单状态
    self.active_orders[order_id]["cancel_requested"] = True
    self.active_orders[order_id]["cancel_reason"] = reason
    
    return True
```

## 撤单状态监控

策略通过以下机制监控撤单请求的执行情况：

1. **撤单确认回调**：当交易所确认撤单成功时，系统会触发回调函数，更新订单状态
2. **撤单超时处理**：如果撤单请求发出后一定时间内未收到确认，系统将重新发送撤单请求
3. **异常情况处理**：当撤单失败时，系统会记录详细日志并通过风控模块评估影响

## 撤单后处理逻辑

根据不同的撤单原因，策略会执行不同的后续处理：

### 时间触发撤单后处理

- **重新评估信号**：判断原信号是否仍然有效
- **价格调整重试**：可选择性调整价格后重新下单
- **资金释放**：释放被锁定的资金用于其他交易机会

### 价格触发撤单后处理

- **冷却时间**：对该股票设置短暂的交易冷却期
- **信号降级**：降低该信号的优先级
- **价格跟踪**：继续跟踪价格变化，等待更好的入场机会

### 风控触发撤单后处理

- **暂停交易**：可能暂停该股票或整个策略的交易
- **风险重估**：重新评估当前市场风险水平
- **资金保护**：将释放的资金转入较低风险的配置

## 撤单相关参数设置

| 参数名称 | 默认值 | 说明 |
|---------|------|------|
| `order_timeout_seconds` | 30 | 订单超时时间，超过后触发撤单 |
| `price_deviation_threshold` | 0.3% | 价格偏离触发撤单的阈值 |
| `session_end_clear_minutes` | 5 | 交易时段结束前多少分钟撤销所有未成交订单 |
| `cancel_retry_count` | 3 | 撤单失败后的最大重试次数 |
| `cancel_retry_interval` | 1.0 | 撤单重试的时间间隔（秒） |
| `enable_auto_adjust_price` | true | 撤单后是否启用自动价格调整重新下单 |
| `max_price_adjust_times` | 2 | 最大价格调整重试次数 |

## 撤单统计与优化

策略会记录和统计所有撤单事件，包括：

1. **撤单原因分布**：各类撤单触发条件的占比
2. **撤单时机分析**：撤单发生的时间分布
3. **撤单后果评估**：分析撤单后价格走势，评估撤单决策的正确性

这些统计数据将用于：

- **参数优化**：根据历史撤单数据优化撤单参数
- **策略改进**：识别可能的策略缺陷并进行改进
- **交易成本分析**：评估撤单对整体交易成本的影响

## 撤单机制的进阶应用

### 自适应撤单参数

策略能够根据不同股票的特性、不同时段的市场状况自动调整撤单参数：

- 对流动性较差的股票，缩短撤单超时时间
- 在市场波动较大的时段，降低价格偏离撤单阈值
- 根据历史成交效率，为每只股票设置个性化的撤单参数

### 人工干预机制

除自动撤单外，系统还支持通过Web管理界面进行人工干预：

- 紧急情况下手动触发全部撤单
- 针对特定股票或订单的定向撤单
- 临时调整撤单参数以应对特殊市场情况

## 常见问题与解决方案

1. **问题**：撤单后价格马上向有利方向移动
   **解决方案**：优化价格偏离阈值，或启用撤单后的自动重试机制

2. **问题**：撤单请求频繁导致交易所限制
   **解决方案**：调整撤单频率控制参数，实施撤单请求节流

3. **问题**：部分券商接口撤单延迟高
   **解决方案**：根据不同券商特性调整撤单超时参数，增加券商相关的适配层 