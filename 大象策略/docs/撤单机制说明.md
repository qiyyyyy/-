# 大象策略撤单机制说明

本文档详细介绍大象策略中的撤单机制实现原理、触发条件、参数配置及相关代码说明，帮助用户了解系统如何管理未成交订单以优化交易结果。

## 一、撤单机制概述

大象策略采用多层次、多触发条件的自适应智能撤单系统，能根据市场状况和订单情况动态决定是否撤销未成交订单。该机制主要解决以下问题：

1. 降低因滑点造成的不利成交风险
2. 避免订单长时间挂在市场未成交，提高资金使用效率
3. 在市场条件快速变化时及时调整交易策略
4. 配合风控系统，在风险状况出现时快速响应

## 二、核心撤单触发条件

系统支持五类撤单触发条件，它们可以同时启用并协同工作：

### 1. 超时撤单

当订单发出后超过指定时间（默认30秒）仍未完全成交时，系统自动撤销未成交部分。这是最基础的撤单机制，防止订单无限期挂在市场上。

```python
# 订单超时处理，位于更新订单状态方法中
if 当前时间 > 订单信息["超时时间"]:
    # 订单超时，尝试取消
    self.取消订单(交易接口, 订单ID)
```

### 2. 价格偏离撤单

当市场价格相对于订单价格发生显著偏离（默认阈值为0.3%）时，系统会自动撤销订单，并根据情况考虑以更合适的价格重新下单。

- 买入订单：市场价格下跌超过阈值，撤单后可以更低价格买入
- 卖出订单：市场价格上涨超过阈值，撤单后可以更高价格卖出

```python
# 价格偏离撤单逻辑示例
if 订单信息["方向"] == "买入":
    偏离比例 = (订单价格 - 当前价格) / 订单价格
    if 偏离比例 > 价格偏离阈值:
        self.撤单处理(交易接口, 订单ID, f"买入价格偏离: {偏离比例:.2%}")
else:  # 卖出订单
    偏离比例 = (当前价格 - 订单价格) / 订单价格
    if 偏离比例 > 价格偏离阈值:
        self.撤单处理(交易接口, 订单ID, f"卖出价格偏离: {偏离比例:.2%}")
```

### 3. 大象信号消失撤单

当原本触发买入或卖出的大象信号强度减弱到阈值以下时，系统会撤销相关联的未成交订单。这确保交易只在大象信号稳定存在时执行。

```python
# 根据大象信号变化撤单
原信号强度 = 订单信息["大象信息"].get("信号强度", 1.0)
当前信号强度 = 大象信号.get(股票代码, 0)

# 如果信号强度下降超过阈值，则撤单
if 当前信号强度 < 原信号强度 * 信号阈值:
    self.撤单处理(交易接口, 订单ID, f"大象信号减弱: {当前信号强度:.2f}/{原信号强度:.2f}")
```

### 4. 风控触发撤单

当策略风控模块触发风险预警时，系统会根据风控级别撤销部分或全部未成交订单。风控触发撤单分为三种情况：

- 全局风控触发：撤销所有未成交订单
- 单股风控触发：撤销特定股票的未成交订单
- 流动性不足撤销：当检测到股票流动性突然下降时的撤单

```python
# 全局风控触发撤单
if 风控状态.get("全局风控触发", False):
    # 全局风控触发，撤销所有活跃订单
    for 订单ID in list(self.活跃订单.keys()):
        self.撤单处理(交易接口, 订单ID, "全局风控触发")
```

### 5. 盘前撤单

在每个交易时段结束前固定时间（默认5分钟）自动撤销所有未成交订单，避免隔夜持仓或午休期间市场风险。

```python
# 交易时段结束前撤单
上午结束前 = 上午结束时间 - timedelta(minutes=分钟数) <= 当前时间 < 上午结束时间
下午结束前 = 下午结束时间 - timedelta(minutes=分钟数) <= 当前时间 < 下午结束时间

if 上午结束前 or 下午结束前:
    时段名 = "上午" if 上午结束前 else "下午"
    # 撤销所有活跃订单
    for 订单ID in list(self.活跃订单.keys()):
        self.撤单处理(交易接口, 订单ID, f"{时段名}交易时段结束前撤单")
```

## 三、撤单后处理逻辑

撤单后，系统会根据不同的撤单原因执行不同的后续处理逻辑：

### 1. 价格偏离撤单后处理

对于因价格偏离而撤销的订单，系统会自动调整价格并重新下单：
- 买入订单：下调价格（默认下调0.5%）并重新下单
- 卖出订单：上调价格（默认上调0.5%）并重新下单

```python
# 价格偏离撤单后的价格调整重新下单
if "价格偏离" in 撤单原因:
    if 方向 == "买入" and "重新下单" not in 撤单原因:
        # 下调买入价格并重新下单
        新价格 = 价格 * 0.995  # 下调0.5%
        新订单ID = self.发送买入订单(交易接口, 股票代码, 新价格, 数量, None, 大象信息)
```

### 2. 大象信号消失撤单后处理

对于因大象信号消失而撤销的订单，系统会设置一个较短的交易冷却期，避免在信号不稳定时频繁交易。

```python
# 大象信号消失后设置冷却期
elif "大象信号" in 撤单原因:
    # 大象信号消失：设置短暂交易冷却期
    self.设置交易冷却期(股票代码, 延长系数=0.5)  # 设置一个较短的冷却期
```

### 3. 风控触发撤单后处理

对于因风控触发而撤销的订单，系统会释放相应资金并根据风控级别决定后续操作，通常不会立即重新下单。

```python
# 风控触发撤单后处理
elif "风控触发" in 撤单原因 or "流动性不足" in 撤单原因:
    # 风控触发或流动性不足：暂不重新下单，释放资金
    处理结果["释放资金"] += 价格 * 数量
```

## 四、撤单相关参数配置

撤单机制涉及以下可配置参数：

| 参数名称 | 默认值 | 说明 |
|---------|------|------|
| `等待时间` | 30秒 | 订单超时时间，超过后触发撤单 |
| `价格偏离阈值` | 0.3% | 价格偏离触发撤单的阈值 |
| `信号阈值` | 0.5 | 大象信号强度降低到原强度的多少比例时触发撤单 |
| `盘前撤单分钟数` | 5分钟 | 交易时段结束前多少分钟撤销所有未成交订单 |

可以在策略配置文件中调整这些参数，或通过Web管理界面实时修改：

```python
# 参数示例
{
    "撤单参数": {
        "等待时间": 30,
        "价格偏离阈值": 0.003,
        "信号阈值": 0.5,
        "盘前撤单分钟数": 5
    }
}
```

## 五、撤单统计与分析

系统会自动记录和统计所有撤单事件，用于策略优化：

### 1. 撤单原因分布

记录各类撤单触发条件的占比，反映市场状况和策略表现。

```python
# 更新原因统计
撤单原因 = 订单信息.get("撤单原因", "未知原因")
self.撤单统计["各原因撤单次数"][撤单原因] = self.撤单统计["各原因撤单次数"].get(撤单原因, 0) + 1
```

### 2. 撤单时间分布

分析撤单发生的时间分布，识别市场哪些时段更容易需要撤单操作。

```python
# 更新时间分布
if 小时 == 9 and 分钟 >= 30 or 小时 == 10 and 分钟 < 0:
    时间段 = "9:30-10:00"
elif (小时 == 10 and 分钟 >= 0) or 小时 == 11:
    时间段 = "10:00-11:30"
```

### 3. 重新下单成功率

跟踪撤单后重新下单的成功率，评估价格调整策略的有效性。

```python
# 计算重新下单成功率
尝试次数 = self.撤单统计["重新下单成功率"]["尝试次数"]
成功次数 = self.撤单统计["重新下单成功率"]["成功次数"]
成功率 = 成功次数 / 尝试次数 if 尝试次数 > 0 else 0
```

## 六、主要接口说明

### 1. 撤单处理

`撤单处理(交易接口, 订单ID, 原因)` 是核心撤单函数，负责记录撤单原因和发送撤单请求。

```python
def 撤单处理(self, 交易接口, 订单ID: str, 原因: str = "") -> bool:
    """
    撤销指定订单，增强版的取消订单方法
    
    参数:
        交易接口: 交易接口对象
        订单ID: 需要撤销的订单ID
        原因: 撤单原因，用于日志记录
    
    返回:
        bool: 撤单请求是否成功发送
    """
    # 检查订单是否存在且未完全成交
    if 订单ID not in self.活跃订单:
        print(f"撤单失败：订单 {订单ID} 不存在或已成交")
        return False
        
    # 记录原始状态和撤单原因
    self.活跃订单[订单ID]["撤单原因"] = 原因
    self.活跃订单[订单ID]["撤单请求时间"] = datetime.now()
    
    # 发送撤单请求
    结果 = self.取消订单(交易接口, 订单ID)
    
    # 记录撤单事件
    print(f"发送撤单请求：订单 {订单ID}，原因：{原因}，结果：{'成功' if 结果 else '失败'}")
    
    return 结果
```

### 2. 更新撤单状态

`更新撤单状态(交易接口, 市场数据, 大象信号, 风控状态)` 是综合撤单机制的入口函数，集成了所有撤单机制。

```python
def 更新撤单状态(self, 交易接口, 市场数据: Dict = None, 大象信号: Dict = None, 风控状态: Dict = None):
    """
    综合检查并处理需要撤单的订单，集成多种撤单机制
    
    参数:
        交易接口: 交易接口对象
        市场数据: 市场数据，包含当前价格等信息
        大象信号: 大象信号状态
        风控状态: 风控状态
        
    返回:
        Dict: 撤单处理结果
    """
    已撤销订单IDs = []
    
    # 1. 检查超时订单(已在更新订单状态中处理)
    self.更新订单状态(交易接口)
    
    # 2. 检查价格偏离撤单
    if 市场数据:
        价格撤单IDs = self.检查价格偏离撤单(交易接口, 市场数据)
        已撤销订单IDs.extend(价格撤单IDs)
    
    # 继续其他撤单检查...
```

## 七、使用建议与最佳实践

1. **参数优化建议**

   根据不同交易品种和市场环境调整撤单参数：
   - 流动性较低的股票：缩短等待时间，降低价格偏离阈值
   - 高波动市场：提高价格偏离阈值，避免频繁撤单
   - 开盘和收盘时段：特别关注大象信号变化，可适当降低信号阈值

2. **风控配合策略**

   撤单机制与风控系统紧密结合，建议：
   - 在日内亏损接近限制时，自动提高撤单敏感度
   - 根据市场波动率动态调整价格偏离阈值
   - 当账户资金接近预警线时，加大盘前撤单时间窗口

3. **监控与优化**

   定期分析撤单统计数据：
   - 关注撤单原因分布，识别策略潜在问题
   - 分析时间分布，找出最适合交易的时段
   - 评估重新下单成功率，优化价格调整策略

## 八、常见问题解答

1. **问题**: 撤单后经常发现价格朝有利方向移动，造成机会损失
   **解决方案**: 调整价格偏离阈值，并考虑使用更复杂的价格预测模型来优化撤单决策

2. **问题**: 系统撤单频率过高，影响交易效率
   **解决方案**: 增加冷却期机制，每次撤单后设置短暂的撤单冷却时间，避免频繁操作

3. **问题**: 某些券商接口撤单延迟高，影响策略效果
   **解决方案**: 为不同券商接口定制撤单参数，对响应较慢的接口适当提前触发撤单

4. **问题**: 如何处理已发出撤单请求但尚未收到确认的状态？
   **解决方案**: 系统会跟踪撤单请求状态，超时未收到确认时会尝试重新发送撤单请求

---

通过本撤单机制，大象策略能够智能管理订单生命周期，大幅提高交易执行质量和资金使用效率，有效应对各种市场情况。 